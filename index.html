<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulaƒçka n√°kladov 3D tlaƒçe | Pro3D.sk</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- 1. CSS VARIABLES & RESET --- */
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --accent: #10b981;
            --accent-hover: #059669;
            --danger: #ef4444;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --input-bg: #f9fafb;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --radius: 16px;
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --bg: #111827;
            --card-bg: #1f2937;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --border: #374151;
            --input-bg: #374151;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        }

        * { box-sizing: border-box; outline: none; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            transition: var(--transition);
        }

        /* --- 2. LAYOUT & COMPONENTS --- */
        .container {
            width: 100%;
            max-width: 900px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .container { grid-template-columns: 1fr 1fr; }
            .full-width { grid-column: span 2; }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
        }
        .header img { max-height: 60px; margin-bottom: 10px; }
        .header h1 { font-size: 1.5rem; margin: 0; font-weight: 700; }

        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        h2 {
            font-size: 1.1rem;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- 3. FORMS & INPUTS --- */
        .form-group { margin-bottom: 15px; }
        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-main);
            font-size: 1rem;
            font-family: inherit;
            transition: var(--transition);
        }

        input:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        }

        /* --- JOB NAME FANCY INPUT --- */
        .job-name-wrapper { position: relative; margin-top: 5px; }
        .job-name-wrapper input {
            padding-left: 35px;
            font-size: 1.6rem;
            font-weight: 800;
            border: none;
            border-bottom: 2px solid transparent;
            background: transparent;
            transition: var(--transition);
            border-radius: 0;
            padding-bottom: 5px;
            color: var(--text-main);
        }
        .job-name-wrapper input:focus {
            border-color: var(--primary);
            box-shadow: none;
        }
        .job-name-icon {
            position: absolute; left: 0; top: 50%; transform: translateY(-50%);
            width: 24px; height: 24px; color: var(--text-muted); transition: var(--transition);
        }
        .job-name-wrapper input:focus ~ .job-name-icon { color: var(--primary); }

        /* --- STEPPER (Vylep≈°en√© ≈°√≠pky) --- */
        .stepper-wrapper {
            display: flex;
            align-items: center;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--input-bg);
            overflow: hidden;
            transition: var(--transition);
        }
        .stepper-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }
        .stepper-wrapper input {
            border: none;
            background: transparent;
            text-align: center;
            border-radius: 0;
            width: 100%;
            -moz-appearance: textfield; /* Firefox */
        }
        .stepper-wrapper input:focus {
            box-shadow: none;
        }
        .stepper-wrapper input::-webkit-outer-spin-button,
        .stepper-wrapper input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .stepper-btn {
            padding: 0;
            width: 44px; /* Dostatoƒçne veƒæk√° plocha pre prst */
            height: 44px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        .stepper-btn.reset-btn {
            width: 30px;
            font-size: 0.85rem;
            font-weight: 700;
            border-right: 1px solid var(--border);
            color: var(--text-muted);
            opacity: 0.7;
            background: rgba(0,0,0,0.1); /* V√Ωraznej≈°ie pozadie */
            font-weight: 800;
            border-radius: 8px 0 0 8px;
        }
        [data-theme="dark"] .stepper-btn.reset-btn {
            background: rgba(255,255,255,0.15); /* V√Ωraznej≈°ie v tmavom re≈æime */
        }
        .stepper-btn.reset-btn:hover { color: var(--danger); background: rgba(239, 68, 68, 0.05); opacity: 1; }
        .stepper-btn:hover {
            background: rgba(0,0,0,0.05);
            color: var(--primary);
        }
        .stepper-btn:active {
            background: rgba(0,0,0,0.1);
            transform: scale(0.95);
        }
        .stepper-btn svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }

        .row { display: flex; gap: 15px; }
        .row > div { flex: 1; }
        
        /* Legend styles */
        .legend {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .legend summary { cursor: pointer; font-weight: 600; }
        .legend[open] summary { margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .legend ul { margin: 0; padding-left: 20px; line-height: 1.6; }

        /* Custom Checkbox */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            background: var(--input-bg);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
        }
        .checkbox-wrapper input { margin-right: 10px; width: 18px; height: 18px; cursor: pointer; }
        .checkbox-wrapper label { margin: 0; cursor: pointer; text-transform: none; color: var(--text-main); }

        /* --- 4. RESULTS & TAGS --- */
        .tag {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .tag.low { background: #d4edda; color: #155724; }
        .tag.high { background: #f8d7da; color: #721c24; }

        .result-box {
            margin-top: auto;
            padding: 20px;
            background: var(--bg);
            border-radius: var(--radius);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .result-box::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 5px;
            background: var(--text-muted);
        }
        .result-box.profit { background: #e8f5e9; }
        .result-box.profit::before { background: var(--accent); }
        [data-theme="dark"] .result-box.profit { background: #1b2e1e; }

        .result-label { font-size: 0.85rem; font-weight: 600; opacity: 0.8; margin-bottom: 5px; }
        .result-value { font-size: 2rem; font-weight: 800; color: var(--text-main); }
        .result-breakdown {
            margin-top: 15px;
            font-size: 0.85rem;
            text-align: left;
            border-top: 1px solid rgba(0,0,0,0.1);
            padding-top: 10px;
        }
        .breakdown-item { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .breakdown-item.total { font-weight: 700; margin-top: 8px; font-size: 1rem; color: var(--accent); }

        /* --- 5. BUTTONS --- */
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); }
        
        .btn-secondary { background: var(--text-muted); color: white; }
        .btn-secondary:hover { background: #5a6268; }

        .btn-print { background: var(--accent); color: white; width: 100%; justify-content: center; margin-top: 10px; }
        .btn-print:hover { background: var(--accent-hover); }

        /* --- MINI CALCULATOR --- */
        .mini-calc-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .mini-calc-overlay.active {
            opacity: 1;
        }
        .mini-calc-box {
            position: fixed;
            bottom: 20px; right: 20px; /* Predvolen√° poz√≠cia */
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            width: 320px;
            max-width: 95%;
            border: 1px solid var(--border);
            pointer-events: auto;
            transform: translateY(20px);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .mini-calc-overlay.active .mini-calc-box {
            transform: translateY(0);
        }
        .mini-calc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: move; /* Indikuje mo≈ænos≈• pres√∫vania */
            user-select: none;
        }
        .mini-calc-header h3 { margin: 0; font-size: 1.1rem; color: var(--text-main); }
        .btn-close-calc { background: transparent; border: none; font-size: 1.5rem; line-height: 1; padding: 0; color: var(--text-muted); cursor: pointer; }
        
        #miniCalcDisplay {
            width: 100%; margin-bottom: 15px; text-align: right; font-size: 1.8rem; font-weight: 700; letter-spacing: 1px;
            background: var(--input-bg); border: 1px solid var(--border); padding: 15px; border-radius: 8px;
        }
        .mini-calc-history {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .history-item {
            display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-muted); padding: 4px 8px; border-radius: 4px; background: rgba(0,0,0,0.02);
        }
        .history-item span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 10px; }
        .history-item strong { white-space: nowrap; color: var(--text-main); font-weight: 600; }
        .mini-calc-keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .mini-calc-keys button {
            padding: 15px 0; font-size: 1.2rem; border-radius: 8px; border: 1px solid var(--border);
            background: var(--bg); color: var(--text-main); justify-content: center; cursor: pointer;
        }
        .mini-calc-keys button:hover { background: var(--border); }
        .key-clear { background-color: var(--danger) !important; color: white !important; border-color: var(--danger) !important; }
        .key-equal { background-color: var(--primary) !important; color: white !important; border-color: var(--primary) !important; grid-row: span 2; height: 100%; }
        .key-zero { grid-column: span 2; width: 100%; }

        /* --- MATERIAL MANAGER --- */
        .btn-link {
            background: none; border: none; padding: 0; color: var(--primary);
            font-size: 0.85rem; cursor: pointer; text-decoration: underline;
            margin-top: 5px; display: inline-block;
        }
        .btn-link:hover { color: var(--primary-hover); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(3px);
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-box {
            background: var(--card-bg); width: 400px; max-width: 90%;
            border-radius: var(--radius); padding: 25px;
            box-shadow: var(--shadow);
            transform: translateY(20px); transition: transform 0.3s;
            max-height: 85vh; display: flex; flex-direction: column;
        }
        .modal-overlay.active .modal-box { transform: translateY(0); }

        .mat-list { overflow-y: auto; flex: 1; margin-bottom: 20px; border: 1px solid var(--border); border-radius: 8px; max-height: 300px; }
        .mat-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; border-bottom: 1px solid var(--border); background: var(--bg); }
        .mat-item:last-child { border-bottom: none; }
        .mat-info { display: flex; flex-direction: column; }
        .mat-name { font-weight: 600; font-size: 0.9rem; }
        .mat-meta { font-size: 0.75rem; color: var(--text-muted); }
        .btn-delete-mat { color: var(--danger); background: rgba(239, 68, 68, 0.1); border: none; width: 30px; height: 30px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-delete-mat:hover { background: var(--danger); color: white; }
        .btn-edit-mat { color: var(--primary); background: rgba(99, 102, 241, 0.1); border: none; width: 30px; height: 30px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-right: 5px; }
        .btn-edit-mat:hover { background: var(--primary); color: white; }

        /* --- 6. PRINT STYLES --- */
        @media screen {
            .print-only { display: none; }
        }

        @media print {
            /* Hide app interface */
            .container, .header, .actions { display: none !important; }
            
            /* Show quote template */
            .print-only { display: block !important; width: 100%; }
            
            body { 
                background: white; 
                color: #1f2937; 
                padding: 40px; 
                font-family: 'Inter', sans-serif;
                display: block; /* Reset flex layout */
            }

            .quote-header { 
                display: flex; 
                justify-content: space-between; 
                align-items: flex-start; 
                margin-bottom: 50px; 
                border-bottom: 2px solid #e5e7eb; 
                padding-bottom: 20px; 
            }
            
            .quote-logo img { max-height: 60px; }
            
            .quote-info { text-align: right; }
            .quote-title { font-size: 24px; font-weight: 800; color: #111; margin: 0 0 5px 0; text-transform: uppercase; letter-spacing: 1px; }
            .quote-date { color: #6b7280; font-size: 14px; }

            .client-info { margin-bottom: 40px; }
            .client-label { font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
            .client-val { font-size: 20px; font-weight: 600; margin-top: 5px; color: #111; }

            table.quote-table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
            table.quote-table th { text-align: left; padding: 15px 10px; border-bottom: 2px solid #111; font-size: 12px; text-transform: uppercase; font-weight: 700; }
            table.quote-table td { padding: 15px 10px; border-bottom: 1px solid #e5e7eb; font-size: 14px; }
            table.quote-table td.num { text-align: right; }
            table.quote-table tr:last-child td { border-bottom: none; }
            
            .quote-total-section { text-align: right; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb; }
            .quote-total-label { font-weight: 600; color: #6b7280; font-size: 14px; margin-right: 15px; }
            .quote-total-val { font-weight: 800; font-size: 28px; color: #111; }

            .quote-footer { 
                position: fixed; bottom: 40px; left: 0; right: 0; 
                text-align: center; font-size: 12px; color: #9ca3af; 
            }
        }
    </style>
</head>
<body data-theme="light">

    <header class="header">
        <div class="logo-container">
            <!-- Placeholder pre logo, ak sa nenaƒç√≠ta -->
            <img src="https://pro3d.sk/wp-content/uploads/2023/10/logo_pro3d_horizontal.png" alt="Pro3D Logo" onerror="this.style.display='none'">
            <h1>Intern√° kalkulaƒçka</h1>
        </div>
    </header>

    <main class="container">
        
        <!-- SEKICIA 1: V√ùROBA -->
        <section class="card">
            <h2>
                1. V√Ωroba (1 podlo≈æka)
                <span id="machineRateTag" class="tag low">PLA/PETG</span>
            </h2>

            <div class="form-group">
                <div class="job-name-wrapper">
                    <input type="text" id="jobName" placeholder="Napr. Dr≈æiak na mobil">
                    <svg class="job-name-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                </div>
            </div>

            <div class="form-group">
                <label for="materialSelect">Materi√°l</label>
                <select id="materialSelect">
                    <!-- Populated by JS -->
                </select>
                <button type="button" class="btn-link" id="btnManageMaterials">‚öôÔ∏è Spravova≈• materi√°ly (Prida≈•/Odobra≈•)</button>
            </div>

            <div class="row">
                <div class="form-group">
                    <label for="materialPrice">Cena (‚Ç¨/kg)</label>
                    <div class="stepper-wrapper">
                        <button type="button" class="stepper-btn reset-btn" data-action="reset" data-target="materialPrice">0</button>
                        <button type="button" class="stepper-btn" data-action="decrement" data-target="materialPrice">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" /></svg>
                        </button>
                        <input type="number" id="materialPrice" value="15" step="0.1">
                        <button type="button" class="stepper-btn" data-action="increment" data-target="materialPrice">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="weight">Celkov√° v√°ha (g)</label>
                    <div class="stepper-wrapper">
                        <button type="button" class="stepper-btn reset-btn" data-action="reset" data-target="weight">0</button>
                        <button type="button" class="stepper-btn" data-action="decrement" data-target="weight">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" /></svg>
                        </button>
                        <input type="number" id="weight" value="50" placeholder="0">
                        <button type="button" class="stepper-btn" data-action="increment" data-target="weight">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="form-group">
                    <label for="printTime">ƒåas tlaƒçe (h)</label>
                    <div class="stepper-wrapper">
                        <button type="button" class="stepper-btn reset-btn" data-action="reset" data-target="printTime">0</button>
                        <button type="button" class="stepper-btn" data-action="decrement" data-target="printTime">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" /></svg>
                        </button>
                        <input type="number" id="printTime" value="2.5" step="0.1" placeholder="0.0">
                        <button type="button" class="stepper-btn" data-action="increment" data-target="printTime">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="adminFee">Fix. poplatok (‚Ç¨)</label>
                    <div class="stepper-wrapper">
                        <button type="button" class="stepper-btn reset-btn" data-action="reset" data-target="adminFee">0</button>
                        <button type="button" class="stepper-btn" data-action="decrement" data-target="adminFee">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" /></svg>
                        </button>
                        <input type="number" id="adminFee" value="0" step="0.1">
                        <button type="button" class="stepper-btn" data-action="increment" data-target="adminFee">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="useAMS" checked>
                    <label for="useAMS">Zapoji≈• AMS (+0.10‚Ç¨/h)</label>
                </div>
            </div>

            <div class="result-box">
                <div class="result-label">N√ÅKLAD NA 1 PODLO≈ΩKU</div>
                <div class="result-value" id="unitCostDisplay">0.00 ‚Ç¨</div>
            </div>
        </section>

        <!-- SEKCIA 2: OBCHOD -->
        <section class="card">
            <h2>2. Obchod a Zisk</h2>

            <div class="row">
                <div class="form-group">
                    <label for="multiplier">Poƒçet podlo≈æiek</label>
                    <div class="stepper-wrapper">
                        <button type="button" class="stepper-btn reset-btn" data-action="reset" data-target="multiplier">0</button>
                        <button type="button" class="stepper-btn" data-action="decrement" data-target="multiplier">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" /></svg>
                        </button>
                        <input type="number" id="multiplier" value="1" min="1">
                        <button type="button" class="stepper-btn" data-action="increment" data-target="multiplier">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="workTime">Tvoja pr√°ca (min)</label>
                    <div class="stepper-wrapper">
                        <button type="button" class="stepper-btn reset-btn" data-action="reset" data-target="workTime">0</button>
                        <button type="button" class="stepper-btn" data-action="decrement" data-target="workTime">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" /></svg>
                        </button>
                        <input type="number" id="workTime" value="0">
                        <button type="button" class="stepper-btn" data-action="increment" data-target="workTime">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="form-group">
                    <label for="margin">Mar≈æa (%)</label>
                    <div class="stepper-wrapper">
                        <button type="button" class="stepper-btn reset-btn" data-action="reset" data-target="margin">0</button>
                        <button type="button" class="stepper-btn" data-action="decrement" data-target="margin">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" /></svg>
                        </button>
                        <input type="number" id="margin" value="20">
                        <button type="button" class="stepper-btn" data-action="increment" data-target="margin">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="tax">Da≈à / DPH (%)</label>
                    <div class="stepper-wrapper">
                        <button type="button" class="stepper-btn reset-btn" data-action="reset" data-target="tax">0</button>
                        <button type="button" class="stepper-btn" data-action="decrement" data-target="tax">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" /></svg>
                        </button>
                        <input type="number" id="tax" value="0">
                        <button type="button" class="stepper-btn" data-action="increment" data-target="tax">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="result-box profit">
                <div class="result-label" style="color: var(--accent);">CENA PRE Z√ÅKAZN√çKA</div>
                <div class="result-value" id="finalPriceDisplay" style="color: var(--accent);">0.00 ‚Ç¨</div>
                
                <div class="result-breakdown" id="breakdownDisplay">
                    <!-- JS will populate this -->
                </div>
            </div>
        </section>

        <!-- LEGENDA -->
        <details class="card legend full-width">
            <summary>‚ÑπÔ∏è Ako sa poƒç√≠ta cena?</summary>
            <ul>
                <li><strong>Materi√°l:</strong> Poƒç√≠ta sa z v√°hy modelu a ceny filamentu. Automaticky sa pripoƒç√≠tava <strong>15% rezerva</strong> na odpad (kalibr√°cia, purge, nepodarky).</li>
                <li><strong>Stroj:</strong> N√°klady na elektrinu a amortiz√°ciu. Sadzba je 0.60‚Ç¨/h (PLA/PETG) alebo 0.75‚Ç¨/h (ASA/PC). Pri pou≈æit√≠ AMS sa pripoƒç√≠tava 0.10‚Ç¨/h.</li>
                <li><strong>Pr√°ca:</strong> Tvoj ƒças str√°ven√Ω pr√≠pravou (slicing), obsluhou tlaƒçiarne alebo post-processingom. Poƒç√≠ta sa sadzbou 10.00‚Ç¨/hod.</li>
                <li><strong>Mar≈æa:</strong> Percentu√°lny zisk, ktor√Ω sa pripoƒç√≠ta k celkov√Ωm n√°kladom (v√Ωroba + pr√°ca). Sl√∫≈æi na rozvoj podnikania a ƒçist√Ω zisk.</li>
                <li><strong>Da≈à:</strong> Suma, ktor√∫ odv√°dza≈° ≈°t√°tu (napr. DPH 20%). Pripoƒç√≠tava sa k cene s mar≈æou.</li>
            </ul>
        </details>

        <!-- OVL√ÅDANIE -->
        <div class="actions full-width">
            <button class="btn-secondary" id="btnTheme">üåì Re≈æim</button>
            <button class="btn-secondary" id="btnMiniCalc">üßÆ Kalkulaƒçka</button>
            <button class="btn-secondary" id="btnReset" style="background: var(--danger);">Vynulova≈•</button>
            <button class="btn-secondary" id="btnFactoryReset" style="background: #4b5563;">üè≠ Factory Reset</button>
            <button class="btn-print" onclick="alert('T√°to funkcia je v ≈°t√°diu rie≈°enia a sl√∫≈æi len na testovanie.'); window.print()">üñ®Ô∏è Stiahnu≈• cenov√∫ ponuku (PDF)</button>
        </div>

    </main>

    <!-- ≈†ABL√ìNA PRE TLAƒå (CENOV√Å PONUKA) -->
    <div class="print-only">
        <div class="quote-header">
            <div class="quote-logo">
                <img src="https://pro3d.sk/wp-content/uploads/2023/10/logo_pro3d_horizontal.png" alt="Pro3D Logo">
            </div>
            <div class="quote-info">
                <h1 class="quote-title">Cenov√° ponuka</h1>
                <div class="quote-date" id="printDate">D√°tum: </div>
            </div>
        </div>

        <div class="client-info">
            <div class="client-label">N√°zov z√°kazky / Projekt</div>
            <div class="client-val" id="printJobName"></div>
        </div>

        <table class="quote-table">
            <thead>
                <tr>
                    <th>Polo≈æka</th>
                    <th class="num">Mno≈æstvo</th>
                    <th class="num">Cena za ks</th>
                    <th class="num">Spolu</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>3D Tlaƒç - <span id="printMaterial"></span></td>
                    <td class="num"><span id="printQty"></span> ks</td>
                    <td class="num"><span id="printUnitPrice"></span> ‚Ç¨</td>
                    <td class="num"><span id="printTotalPrice"></span> ‚Ç¨</td>
                </tr>
            </tbody>
        </table>

        <div class="quote-total-section">
            <span class="quote-total-label">CELKOM K √öHRADE</span>
            <span class="quote-total-val"><span id="printFinalTotal"></span> ‚Ç¨</span>
        </div>

        <div class="quote-footer">
            Platnos≈• cenovej ponuky je 14 dn√≠. Dokument vygenerovan√Ω syst√©mom Pro3D.sk
        </div>
    </div>

    <!-- MINI KALKULAƒåKA MODAL -->
    <div class="mini-calc-overlay" id="miniCalcOverlay">
        <div class="mini-calc-box">
            <div class="mini-calc-header">
                <h3>R√Ωchle v√Ωpoƒçty</h3>
                <button class="btn-close-calc" id="closeMiniCalc">√ó</button>
            </div>
            <input type="text" id="miniCalcDisplay" readonly value="0">
            <div class="mini-calc-history" id="miniCalcHistory"></div>
            <div class="mini-calc-keys">
                <button class="key-clear" onclick="MiniCalc.clear()">C</button>
                <button onclick="MiniCalc.append('/')">/</button>
                <button onclick="MiniCalc.append('*')">*</button>
                <button onclick="MiniCalc.backspace()">‚å´</button>
                <button onclick="MiniCalc.append('7')">7</button>
                <button onclick="MiniCalc.append('8')">8</button>
                <button onclick="MiniCalc.append('9')">9</button>
                <button onclick="MiniCalc.append('-')">-</button>
                <button onclick="MiniCalc.append('4')">4</button>
                <button onclick="MiniCalc.append('5')">5</button>
                <button onclick="MiniCalc.append('6')">6</button>
                <button onclick="MiniCalc.append('+')">+</button>
                <button onclick="MiniCalc.append('1')">1</button>
                <button onclick="MiniCalc.append('2')">2</button>
                <button onclick="MiniCalc.append('3')">3</button>
                <button class="key-equal" onclick="MiniCalc.calculate()">=</button>
                <button class="key-zero" onclick="MiniCalc.append('0')">0</button>
                <button onclick="MiniCalc.append('.')">.</button>
            </div>
        </div>
    </div>

    <!-- MATERIAL MANAGER MODAL -->
    <div class="modal-overlay" id="materialManagerOverlay">
        <div class="modal-box">
            <div class="mini-calc-header">
                <h3>Spr√°va materi√°lov</h3>
                <button class="btn-close-calc" id="closeMaterialManager">√ó</button>
            </div>
            
            <div class="mat-list" id="materialListContainer">
                <!-- List will be here -->
            </div>

            <div style="margin-top: 15px; padding: 15px; background: rgba(99, 102, 241, 0.08); border: 2px solid var(--border); border-radius: 8px;">
                <h4 style="margin: 0 0 15px 0; font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted);">Prida≈• nov√Ω materi√°l</h4>
                
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="newMatName" style="font-size: 0.75rem;">N√°zov materi√°lu</label>
                    <input type="text" id="newMatName" placeholder="Napr. Nylon Carbon">
                </div>

                <div class="row" style="margin-bottom: 15px;">
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label for="newMatPrice" style="font-size: 0.75rem;">Cena (‚Ç¨/kg)</label>
                        <div class="stepper-wrapper">
                            <button type="button" class="stepper-btn reset-btn" data-action="reset" data-target="newMatPrice">0</button>
                            <button type="button" class="stepper-btn" data-action="decrement" data-target="newMatPrice">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" /></svg>
                            </button>
                            <input type="number" id="newMatPrice" placeholder="0.0" step="0.1">
                            <button type="button" class="stepper-btn" data-action="increment" data-target="newMatPrice">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label for="newMatType" style="font-size: 0.75rem;">Teplota</label>
                        <select id="newMatType">
                            <option value="low">N√≠zka</option>
                            <option value="high">Vysok√°</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn-primary" style="width: 100%; justify-content: center;" id="btnAddMaterial">Prida≈• do zoznamu</button>
            </div>
        </div>
    </div>

    <!-- EDIT MATERIAL MODAL -->
    <div class="modal-overlay" id="editMaterialOverlay">
        <div class="modal-box">
            <div class="mini-calc-header">
                <h3>Upravi≈• materi√°l</h3>
                <button class="btn-close-calc" id="closeEditMaterial">√ó</button>
            </div>
            <input type="hidden" id="editMatId">
            <div class="form-group" style="margin-bottom: 15px;">
                <label for="editMatName">N√°zov materi√°lu</label>
                <input type="text" id="editMatName">
            </div>
            <div class="row" style="margin-bottom: 15px;">
                <div class="form-group">
                    <label for="editMatPrice">Cena (‚Ç¨/kg)</label>
                    <div class="stepper-wrapper">
                        <button type="button" class="stepper-btn reset-btn" data-action="reset" data-target="editMatPrice">0</button>
                        <button type="button" class="stepper-btn" data-action="decrement" data-target="editMatPrice">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" /></svg>
                        </button>
                        <input type="number" id="editMatPrice" step="0.1">
                        <button type="button" class="stepper-btn" data-action="increment" data-target="editMatPrice">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editMatType">Teplota</label>
                    <select id="editMatType">
                        <option value="low">N√≠zka</option>
                        <option value="high">Vysok√°</option>
                    </select>
                </div>
            </div>
            <button class="btn-primary" style="width: 100%; justify-content: center;" id="btnSaveMaterial">Ulo≈æi≈• zmeny</button>
        </div>
    </div>

<script>
/**
 * LOGIKA KALKULAƒåKY
 * Oddelen√° od UI pre lep≈°iu ƒçitateƒænos≈• a √∫dr≈æbu.
 */
const Calculator = {
    CONSTANTS: {
        LABOR_RATE_PER_HOUR: 10.00,
        WASTE_MULTIPLIER: 1.15, // 15% odpad
        RATE_LOW_TEMP: 0.60,
        RATE_HIGH_TEMP: 0.75,
        AMS_SURCHARGE: 0.10
    },

    // Z√≠ska hodinov√∫ sadzbu stroja na z√°klade typu materi√°lu a AMS
    getMachineRate(tempType, useAMS) {
        let baseRate = tempType === 'high' 
            ? this.CONSTANTS.RATE_HIGH_TEMP 
            : this.CONSTANTS.RATE_LOW_TEMP;
        
        if (useAMS) {
            baseRate += this.CONSTANTS.AMS_SURCHARGE;
        }
        return baseRate;
    },

    // V√Ωpoƒçet n√°kladov na v√Ωrobu 1 kusu
    calculateProductionCost(inputs) {
        const { weightG, materialPricePerKg, printTimeH, adminFee, machineRate } = inputs;

        const materialCost = (weightG / 1000) * materialPricePerKg * this.CONSTANTS.WASTE_MULTIPLIER;
        const machineCost = printTimeH * machineRate;
        
        return materialCost + machineCost + adminFee;
    },

    // V√Ωpoƒçet fin√°lnej ceny a zisku
    calculateFinalPrice(unitCost, inputs) {
        const { multiplier, workTimeMin, marginPercent, taxPercent } = inputs;

        const totalProductionCost = unitCost * multiplier;
        const laborCost = (workTimeMin / 60) * this.CONSTANTS.LABOR_RATE_PER_HOUR;
        
        const subTotal = totalProductionCost + laborCost;
        const priceNoTax = subTotal * (1 + (marginPercent / 100));
        const profitFromMargin = priceNoTax - subTotal;
        
        const taxAmount = priceNoTax * (taxPercent / 100);
        const priceWithTax = priceNoTax + taxAmount;
        
        // Zaokr√∫hƒæovanie podƒæa pravidla: do 20 centov nadol, od 20 centov nahor (v r√°mci 0.50 krokov)
        const cents = Math.round(priceWithTax * 100);
        const remainder50 = cents % 50; // Zvy≈°ok po delen√≠ 50 centami
        
        let roundedCents = cents - remainder50; // Z√°klad (podlaha na najbli≈æ≈°√≠ch 50 centov)
        if (remainder50 > 20) roundedCents += 50; // Ak je zvy≈°ok viac ako 20, zaokr√∫hli≈• nahor
        
        const roundedPrice = roundedCents / 100;
        const roundingDiff = roundedPrice - priceWithTax;
        
        const totalProfit = laborCost + profitFromMargin + roundingDiff;

        return {
            totalProductionCost,
            laborCost,
            profitFromMargin,
            totalProfit,
            priceNoTax,
            taxAmount,
            priceWithTax,
            roundedPrice
        };
    }
};

/**
 * MINI KALKULAƒåKA
 */
const MiniCalc = {
    display: null,
    historyContainer: null,
    history: [],
    shouldReset: false, // Flag pre nov√Ω v√Ωpoƒçet
    
    init() {
        this.display = document.getElementById('miniCalcDisplay');
        this.historyContainer = document.getElementById('miniCalcHistory');
        document.addEventListener('keydown', (e) => this.handleKeyboard(e));
        this.initDrag();
    },

    append(val) {
        const isOperator = ['.', '/', '*', '-', '+'].includes(val);

        // Ak m√°me zaƒça≈• nov√Ω pr√≠klad a u≈æ√≠vateƒæ zadal ƒç√≠slo (nie oper√°tor)
        if (this.shouldReset) {
            this.shouldReset = false;
            if (!isOperator) this.display.value = '0';
        }

        if (this.display.value === '0' && !isOperator) {
            this.display.value = val;
        } else {
            this.display.value += val;
        }
    },

    clear() {
        this.display.value = '0';
    },

    backspace() {
        this.display.value = this.display.value.slice(0, -1) || '0';
    },

    calculate() {
        try {
            const expression = this.display.value;
            // Bezpeƒçn√© vyhodnotenie matematick√©ho v√Ωrazu
            const result = eval(expression.replace(/[^-()\d/*+.]/g, ''));
            this.display.value = result;
            this.addToHistory(expression, result);
            this.shouldReset = true; // Nastav√≠me flag, ≈æe ƒèal≈°√≠ vstup m√° resetova≈• displej
        } catch (e) {
            this.display.value = 'Error';
            setTimeout(() => this.clear(), 1000);
        }
    },

    addToHistory(expr, res) {
        // Prida≈• na zaƒçiatok
        this.history.unshift({ expr, res });
        // Udr≈æa≈• len 5 posledn√Ωch
        if (this.history.length > 5) this.history.pop();
        this.renderHistory();
    },

    renderHistory() {
        this.historyContainer.innerHTML = this.history.map(item => `
            <div class="history-item">
                <span>${item.expr} =</span>
                <strong>${item.res}</strong>
            </div>
        `).join('');
    },

    handleKeyboard(e) {
        const overlay = document.getElementById('miniCalcOverlay');
        if (!overlay.classList.contains('active')) return;

        // Ignorova≈• ak u≈æ√≠vateƒæ p√≠≈°e do formul√°ra
        const activeEl = document.activeElement;
        const tag = activeEl.tagName;
        if ((tag === 'INPUT' || tag === 'SELECT' || tag === 'TEXTAREA') && activeEl.id !== 'miniCalcDisplay') return;

        const key = e.key;

        if (/^[0-9.+\-*/]$/.test(key)) {
            e.preventDefault();
            this.append(key);
        } else if (key === ',') {
            e.preventDefault();
            this.append('.');
        } else if (key === 'Enter' || key === '=') {
            e.preventDefault();
            this.calculate();
        } else if (key === 'Backspace') {
            e.preventDefault();
            this.backspace();
        } else if (key === 'Escape' || key.toLowerCase() === 'c') {
            e.preventDefault();
            this.clear();
        }
    },

    initDrag() {
        const box = document.querySelector('.mini-calc-box');
        const header = document.querySelector('.mini-calc-header');
        
        header.addEventListener('mousedown', (e) => {
            // Ignorova≈• kliknutie na tlaƒçidlo zavrie≈•
            if (e.target.closest('.btn-close-calc')) return;

            e.preventDefault();
            
            // Z√≠ska≈• aktu√°lnu poz√≠ciu a offset my≈°i
            const rect = box.getBoundingClientRect();
            const shiftX = e.clientX - rect.left;
            const shiftY = e.clientY - rect.top;

            // Prepnutie na absol√∫tne poziciovanie podƒæa okna
            box.style.bottom = 'auto';
            box.style.right = 'auto';
            box.style.left = rect.left + 'px';
            box.style.top = rect.top + 'px';
            box.style.transition = 'none'; // Vypn√∫≈• anim√°ciu poƒças ≈•ahania

            const onMouseMove = (ev) => {
                box.style.left = (ev.clientX - shiftX) + 'px';
                box.style.top = (ev.clientY - shiftY) + 'px';
            };

            const onMouseUp = () => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                box.style.transition = ''; // Vr√°ti≈• anim√°ciu
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    }
};

/**
 * MATERIAL MANAGER
 */
const MaterialManager = {
    materials: [],
    defaults: [
        { id: 'def1', name: 'PLA Standard', price: 15, type: 'low', category: 'Standard' },
        { id: 'def2', name: 'PETG Standard', price: 15, type: 'low', category: 'Standard' },
        { id: 'def3', name: 'ASA Standard', price: 20, type: 'high', category: 'Standard' },
        { id: 'def4', name: 'PC Standard', price: 30, type: 'high', category: 'Standard' },
        { id: 'def5', name: 'TPU Standard', price: 25, type: 'low', category: 'Standard' },
        { id: 'def6', name: 'PLA Profi', price: 20, type: 'low', category: 'Profi' },
        { id: 'def7', name: 'PETG Profi', price: 20, type: 'low', category: 'Profi' },
        { id: 'def8', name: 'ASA Profi', price: 25, type: 'high', category: 'Profi' },
        { id: 'def9', name: 'PC Profi', price: 40, type: 'high', category: 'Profi' },
        { id: 'def10', name: 'TPU Profi', price: 40, type: 'low', category: 'Profi' }
    ],

    init() {
        this.load();
        this.renderSelect();
        this.bindEvents();
    },

    load() {
        const saved = localStorage.getItem('all_materials');
        if (saved) {
            this.materials = JSON.parse(saved);
        } else {
            // Deep copy defaults to avoid reference issues (ƒçist√° k√≥pia)
            this.materials = JSON.parse(JSON.stringify(this.defaults));
            this.save();
        }
    },

    save() {
        localStorage.setItem('all_materials', JSON.stringify(this.materials));
        this.renderSelect();
        this.renderList();
    },

    add(name, price, type) {
        const newMat = {
            id: 'custom_' + Date.now(),
            name,
            price: parseFloat(price),
            type,
            category: 'Vlastn√©'
        };
        this.materials.push(newMat);
        this.save();
    },

    remove(id) {
        this.materials = this.materials.filter(m => m.id !== id);
        this.save();
    },

    updateMaterial(id, name, price, type) {
        const index = this.materials.findIndex(m => m.id === id);
        if (index !== -1) {
            this.materials[index].name = name;
            this.materials[index].price = parseFloat(price);
            this.materials[index].type = type;
            this.save();
        }
    },

    edit(id) {
        const mat = this.materials.find(m => m.id === id);
        if (mat) {
            // Otvori≈• editovacie okno namiesto mazania
            document.getElementById('editMatId').value = mat.id;
            document.getElementById('editMatName').value = mat.name;
            document.getElementById('editMatPrice').value = mat.price;
            document.getElementById('editMatType').value = mat.type;
            
            // Zobrazi≈• modal (rie≈°i App trieda cez eventy, ale tu m√¥≈æeme priamo vola≈• overlay ak chceme, 
            // alebo lep≈°ie - vyvola≈• custom event. Pre jednoduchos≈• tu pou≈æijeme priamy pr√≠stup k DOM v App)
            document.getElementById('editMaterialOverlay').classList.add('active');
        }
    },

    renderSelect() {
        const select = document.getElementById('materialSelect');
        const currentVal = select.value;
        select.innerHTML = '';

        // Zoskupenie podƒæa kateg√≥ri√≠
        const categories = {};
        this.materials.forEach(mat => {
            const cat = mat.category || 'Ostatn√©';
            if (!categories[cat]) categories[cat] = [];
            categories[cat].push(mat);
        });

        for (const [catName, mats] of Object.entries(categories)) {
            const group = document.createElement('optgroup');
            group.label = catName;
            mats.forEach(mat => {
                const opt = document.createElement('option');
                opt.value = mat.price;
                opt.setAttribute('data-temp', mat.type);
                opt.textContent = `${mat.name} (${mat.price}‚Ç¨)`;
                group.appendChild(opt);
            });
            select.appendChild(group);
        }
        
        if (currentVal) select.value = currentVal;
    },

    renderList() {
        const container = document.getElementById('materialListContainer');
        container.innerHTML = this.materials.map(mat => `
                <div class="mat-item">
                    <div class="mat-info">
                        <span class="mat-name">${mat.name}</span>
                        <div class="mat-meta" style="display: flex; gap: 8px; align-items: center; margin-top: 4px;">
                            <span style="font-weight: bold; color: var(--text-main);">${parseFloat(mat.price).toFixed(2)} ‚Ç¨/kg</span>
                            <span style="font-size: 0.75rem; color: var(--text-muted); background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px;">${mat.type === 'high' ? 'üî• Vysok√°' : 'üå± N√≠zka'}</span>
                        </div>
                    </div>
                    <div style="display:flex;">
                        <button class="btn-edit-mat" onclick="MaterialManager.edit('${mat.id}')" title="Upravi≈•">‚úé</button>
                        <button class="btn-delete-mat" onclick="MaterialManager.remove('${mat.id}')" title="Vymaza≈•">√ó</button>
                    </div>
                </div>
        `).join('');
    },

    bindEvents() {
        document.getElementById('btnAddMaterial').addEventListener('click', () => {
            const name = document.getElementById('newMatName').value;
            const price = document.getElementById('newMatPrice').value;
            const type = document.getElementById('newMatType').value;

            if (name && price) {
                this.add(name, price, type);
                document.getElementById('newMatName').value = '';
                document.getElementById('newMatPrice').value = '';
            }
        });
    }
};

/**
 * UI MANA≈ΩMENT
 * Star√° sa o DOM elementy a eventy.
 */
const App = {
    elements: {},

    init() {
        this.cacheElements();
        this.bindEvents();
        this.loadTheme();
        // Inicializova≈• materi√°ly PRED prv√Ωm update, aby sa naplnil select
        MaterialManager.init();
        this.loadState(); // Naƒç√≠ta≈• ulo≈æen√© hodnoty
        this.update(); // Prv√Ω v√Ωpoƒçet
        MiniCalc.init();
    },

    cacheElements() {
        // Inputs
        this.elements.jobName = document.getElementById('jobName');
        this.elements.materialSelect = document.getElementById('materialSelect');
        this.elements.materialPrice = document.getElementById('materialPrice');
        this.elements.weight = document.getElementById('weight');
        this.elements.printTime = document.getElementById('printTime');
        this.elements.adminFee = document.getElementById('adminFee');
        this.elements.useAMS = document.getElementById('useAMS');
        this.elements.multiplier = document.getElementById('multiplier');
        this.elements.workTime = document.getElementById('workTime');
        this.elements.margin = document.getElementById('margin');
        this.elements.tax = document.getElementById('tax');

        // Outputs
        this.elements.machineRateTag = document.getElementById('machineRateTag');
        this.elements.unitCostDisplay = document.getElementById('unitCostDisplay');
        this.elements.finalPriceDisplay = document.getElementById('finalPriceDisplay');
        this.elements.breakdownDisplay = document.getElementById('breakdownDisplay');

        // Print Elements
        this.elements.printDate = document.getElementById('printDate');
        this.elements.printJobName = document.getElementById('printJobName');
        this.elements.printMaterial = document.getElementById('printMaterial');
        this.elements.printQty = document.getElementById('printQty');
        this.elements.printUnitPrice = document.getElementById('printUnitPrice');
        this.elements.printTotalPrice = document.getElementById('printTotalPrice');
        this.elements.printFinalTotal = document.getElementById('printFinalTotal');

        // Buttons
        this.elements.btnTheme = document.getElementById('btnTheme');
        this.elements.btnReset = document.getElementById('btnReset');
        this.elements.btnFactoryReset = document.getElementById('btnFactoryReset');
        
        // Mini Calc
        this.elements.btnMiniCalc = document.getElementById('btnMiniCalc');
        this.elements.miniCalcOverlay = document.getElementById('miniCalcOverlay');
        this.elements.closeMiniCalc = document.getElementById('closeMiniCalc');

        // Material Manager
        this.elements.btnManageMaterials = document.getElementById('btnManageMaterials');
        this.elements.materialManagerOverlay = document.getElementById('materialManagerOverlay');
        this.elements.closeMaterialManager = document.getElementById('closeMaterialManager');
        
        // Edit Material Modal
        this.elements.editMaterialOverlay = document.getElementById('editMaterialOverlay');
        this.elements.closeEditMaterial = document.getElementById('closeEditMaterial');
        this.elements.btnSaveMaterial = document.getElementById('btnSaveMaterial');
    },

    bindEvents() {
        // Input listeners pre prepoƒçet
        const inputs = [
            'materialPrice', 'weight', 'printTime', 'adminFee', 
            'useAMS', 'multiplier', 'workTime', 'margin', 'tax'
        ];
        inputs.forEach(id => {
            document.getElementById(id).addEventListener('input', () => this.update());
        });

        // ≈†peci√°lny listener pre select (zmena ceny a typu)
        this.elements.materialSelect.addEventListener('change', () => {
            this.elements.materialPrice.value = this.elements.materialSelect.value;
            this.update();
        });

        // Buttons
        this.elements.btnTheme.addEventListener('click', () => this.toggleTheme());
        this.elements.btnReset.addEventListener('click', () => this.reset());
        this.elements.btnFactoryReset.addEventListener('click', () => this.factoryReset());
        
        // Mini Calc Toggles
        this.elements.btnMiniCalc.addEventListener('click', () => {
            this.elements.miniCalcOverlay.classList.add('active');
        });
        this.elements.closeMiniCalc.addEventListener('click', () => {
            this.elements.miniCalcOverlay.classList.remove('active');
        });

        // Material Manager Toggles
        this.elements.btnManageMaterials.addEventListener('click', () => {
            this.elements.materialManagerOverlay.classList.add('active');
            MaterialManager.renderList();
        });
        this.elements.closeMaterialManager.addEventListener('click', () => {
            this.elements.materialManagerOverlay.classList.remove('active');
        });

        // Edit Material Logic
        this.elements.closeEditMaterial.addEventListener('click', () => {
            this.elements.editMaterialOverlay.classList.remove('active');
        });
        
        this.elements.btnSaveMaterial.addEventListener('click', () => {
            const id = document.getElementById('editMatId').value;
            const name = document.getElementById('editMatName').value;
            const price = document.getElementById('editMatPrice').value;
            const type = document.getElementById('editMatType').value;
            
            MaterialManager.updateMaterial(id, name, price, type);
            this.elements.editMaterialOverlay.classList.remove('active');
        });

        // Stepper Buttons Logic
        document.querySelectorAll('.stepper-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const action = btn.dataset.action;
                const targetId = btn.dataset.target;
                const input = document.getElementById(targetId);
                
                let val = parseFloat(input.value) || 0;
                const step = parseFloat(input.step) || 1;
                const min = parseFloat(input.min);

                if (action === 'increment') val += step;
                else if (action === 'decrement') val -= step;
                else if (action === 'reset') val = (!isNaN(min) ? min : 0);

                // O≈°etrenie minima a zaokr√∫hlenie (pre desatinn√© ƒç√≠sla)
                if (!isNaN(min) && val < min) val = min;
                val = Math.round(val * 100) / 100;

                input.value = val;
                input.dispatchEvent(new Event('input')); // Spust√≠ prepoƒçet
            });
        });

        // Zatv√°ranie okien pri kliknut√≠ mimo (na pozadie)
        document.querySelectorAll('.modal-overlay, .mini-calc-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });
    },

    getInputs() {
        const matOption = this.elements.materialSelect.options[this.elements.materialSelect.selectedIndex];
        
        return {
            tempType: matOption.getAttribute('data-temp'),
            materialPricePerKg: parseFloat(this.elements.materialPrice.value) || 0,
            weightG: parseFloat(this.elements.weight.value) || 0,
            printTimeH: parseFloat(this.elements.printTime.value) || 0,
            adminFee: parseFloat(this.elements.adminFee.value) || 0,
            useAMS: this.elements.useAMS.checked,
            multiplier: parseFloat(this.elements.multiplier.value) || 1,
            workTimeMin: parseFloat(this.elements.workTime.value) || 0,
            marginPercent: parseFloat(this.elements.margin.value) || 0,
            taxPercent: parseFloat(this.elements.tax.value) || 0
        };
    },

    update() {
        const inputs = this.getInputs();

        // 1. Zisti sadzbu stroja
        const machineRate = Calculator.getMachineRate(inputs.tempType, inputs.useAMS);
        this.updateMachineTag(inputs.tempType, machineRate);

        // 2. Vypoƒç√≠taj n√°klad na 1 kus
        const unitCost = Calculator.calculateProductionCost({ ...inputs, machineRate });
        
        // 3. Vypoƒç√≠taj fin√°lne ƒç√≠sla
        const results = Calculator.calculateFinalPrice(unitCost, inputs);

        // 4. Vykresli
        this.render(unitCost, results, inputs.multiplier);
        this.saveState(); // Ulo≈æi≈• aktu√°lny stav
    },

    updateMachineTag(tempType, rate) {
        const tag = this.elements.machineRateTag;
        const isHigh = tempType === 'high';
        
        // Pou≈æitie ikon namiesto textu PLA/ASA
        const icon = isHigh ? 'üî•' : 'üå±';
        const label = isHigh ? 'Vysok√° teplota' : 'N√≠zka teplota';
        
        tag.innerHTML = `${icon} ${rate.toFixed(2)}‚Ç¨/h`;
        tag.title = label; // Tooltip po nabehnut√≠ my≈°ou
        tag.className = `tag ${isHigh ? 'high' : 'low'}`;
    },

    render(unitCost, results, count) {
        // Anim√°cia ƒç√≠sel by sa dala prida≈• tu, ale pre jednoduchos≈• men√≠me text
        this.elements.unitCostDisplay.textContent = unitCost.toFixed(2) + " ‚Ç¨";
        this.elements.finalPriceDisplay.innerHTML = `
            <div style="font-size: 0.4em; opacity: 0.6; margin-bottom: 5px; font-weight: 600;">Presne: ${results.priceWithTax.toFixed(2)} ‚Ç¨</div>
            ${results.roundedPrice.toFixed(2)} ‚Ç¨
        `;

        this.elements.breakdownDisplay.innerHTML = `
            <div class="breakdown-item">
                <span>V√Ωrobn√© n√°klady (${count} podlo≈æiek)</span>
                <span>${results.totalProductionCost.toFixed(2)} ‚Ç¨</span>
            </div>
            <div class="breakdown-item">
                <span>Tvoja pr√°ca</span>
                <span>${results.laborCost.toFixed(2)} ‚Ç¨</span>
            </div>
            <div class="breakdown-item">
                <span>Mar≈æa</span>
                <span>${results.profitFromMargin.toFixed(2)} ‚Ç¨</span>
            </div>
            <div class="breakdown-item" style="opacity: 0.7;">
                <span>Cena bez DPH</span>
                <span>${results.priceNoTax.toFixed(2)} ‚Ç¨</span>
            </div>
            <div class="breakdown-item" style="color: var(--danger);">
                <span>Da≈à (≈°t√°tu)</span>
                <span>${results.taxAmount.toFixed(2)} ‚Ç¨</span>
            </div>
            <div class="breakdown-item total">
                <span>Tvoj ƒçist√Ω zisk</span>
                <span>${results.totalProfit.toFixed(2)} ‚Ç¨</span>
            </div>
        `;

        // Update Print View
        const date = new Date().toLocaleDateString('sk-SK');
        this.elements.printDate.textContent = `D√°tum: ${date}`;
        this.elements.printJobName.textContent = this.elements.jobName.value || "Bez n√°zvu";
        
        const matText = this.elements.materialSelect.options[this.elements.materialSelect.selectedIndex].text;
        this.elements.printMaterial.textContent = matText.split('(')[0].trim(); // Odstr√°ni cenu zo z√°tvorky
        
        this.elements.printQty.textContent = count;
        
        // Jednotkov√° cena pre z√°kazn√≠ka (vydelen√° celkov√° suma poƒçtom kusov)
        const unitPriceForCustomer = results.roundedPrice / count;
        this.elements.printUnitPrice.textContent = unitPriceForCustomer.toFixed(2);
        this.elements.printTotalPrice.textContent = results.roundedPrice.toFixed(2);
        this.elements.printFinalTotal.textContent = results.roundedPrice.toFixed(2);
    },

    toggleTheme() {
        const body = document.body;
        const current = body.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        body.setAttribute('data-theme', next);
        localStorage.setItem('theme', next); // Ulo≈æenie do pam√§te
    },

    loadTheme() {
        const saved = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', saved);
    },

    reset() {
        this.elements.jobName.value = '';
        this.elements.materialSelect.selectedIndex = 0; // PLA Standard (prv√° mo≈ænos≈•)
        this.elements.materialPrice.value = 15;
        this.elements.weight.value = 50;
        this.elements.printTime.value = 2.5;
        this.elements.adminFee.value = 0;
        this.elements.useAMS.checked = true;
        this.elements.multiplier.value = 1;
        this.elements.workTime.value = 0;
        this.elements.margin.value = 20;
        this.elements.tax.value = 0;
        this.update();
    },

    factoryReset() {
        if (confirm('Naozaj chcete obnovi≈• v√Ωrobn√© nastavenia? Vyma≈æ√∫ sa v≈°etky vlastn√© materi√°ly a zmeny.')) {
            localStorage.removeItem('all_materials');
            MaterialManager.load(); // Naƒç√≠ta defaultn√© hodnoty
            MaterialManager.renderSelect();
            MaterialManager.renderList();
            this.reset();
        }
    },

    saveState() {
        const state = {
            jobName: this.elements.jobName.value,
            materialSelectIndex: this.elements.materialSelect.selectedIndex,
            materialPrice: this.elements.materialPrice.value,
            weight: this.elements.weight.value,
            printTime: this.elements.printTime.value,
            adminFee: this.elements.adminFee.value,
            useAMS: this.elements.useAMS.checked,
            multiplier: this.elements.multiplier.value,
            workTime: this.elements.workTime.value,
            margin: this.elements.margin.value,
            tax: this.elements.tax.value
        };
        localStorage.setItem('calc_state', JSON.stringify(state));
    },

    loadState() {
        const saved = localStorage.getItem('calc_state');
        if (!saved) return;
        
        try {
            const state = JSON.parse(saved);
            
            if (state.jobName !== undefined) this.elements.jobName.value = state.jobName;
            if (state.materialSelectIndex !== undefined && state.materialSelectIndex < this.elements.materialSelect.options.length) {
                this.elements.materialSelect.selectedIndex = state.materialSelectIndex;
            }
            if (state.materialPrice !== undefined) this.elements.materialPrice.value = state.materialPrice;
            if (state.weight !== undefined) this.elements.weight.value = state.weight;
            if (state.printTime !== undefined) this.elements.printTime.value = state.printTime;
            if (state.adminFee !== undefined) this.elements.adminFee.value = state.adminFee;
            if (state.useAMS !== undefined) this.elements.useAMS.checked = state.useAMS;
            if (state.multiplier !== undefined) this.elements.multiplier.value = state.multiplier;
            if (state.workTime !== undefined) this.elements.workTime.value = state.workTime;
            if (state.margin !== undefined) this.elements.margin.value = state.margin;
            if (state.tax !== undefined) this.elements.tax.value = state.tax;
        } catch (e) {
            console.error("Chyba pri naƒç√≠tan√≠ stavu:", e);
        }
    }
};

// Exportovanie objektov do glob√°lneho rozsahu pre HTML event handlery (oprava MiniCalc)
window.MiniCalc = MiniCalc;
window.MaterialManager = MaterialManager;
window.App = App;

// Spustenie aplik√°cie
document.addEventListener('DOMContentLoaded', () => App.init());
</script>

</body>
</html>
